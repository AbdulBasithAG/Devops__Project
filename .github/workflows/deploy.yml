name: Deploy Infra + App to GKE

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  IMAGE_NAME: hello-app
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-south1
  CLUSTER_NAME: simple-gke   # ğŸ‘ˆ Replace with your actual cluster name

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ğŸ” Authenticate
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      # ğŸ” STEP 1: Check if cluster exists
      - name: Check if GKE cluster exists
        id: check_cluster
        run: |
          if gcloud container clusters describe $CLUSTER_NAME \
            --region $REGION \
            --project $PROJECT_ID > /dev/null 2>&1; then
              echo "cluster_exists=true" >> $GITHUB_OUTPUT
              echo "Cluster already exists. Skipping Terraform."
          else
              echo "cluster_exists=false" >> $GITHUB_OUTPUT
              echo "Cluster does not exist. Terraform will run."
          fi

      # ğŸ— Setup Terraform
      - name: Setup Terraform
        if: steps.check_cluster.outputs.cluster_exists == 'false'
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        if: steps.check_cluster.outputs.cluster_exists == 'false'
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        if: steps.check_cluster.outputs.cluster_exists == 'false'
        working-directory: terraform
        run: terraform apply -auto-approve -var="project_id=${{ env.PROJECT_ID }}"

      # ğŸ³ Docker Login
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ğŸ³ Build Image
      - name: Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest -f docker/Dockerfile .

      # ğŸ” Scan Image (Better approach using official action)
      - name: Scan Docker Image with Trivy
        uses: aquasecurity/trivy-action@v0.20.0
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/hello-app:latest
          format: table
          exit-code: 0
          severity: HIGH,CRITICAL

      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest

      # ğŸ”‘ Get GKE Credentials
      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials $CLUSTER_NAME \
            --region $REGION \
            --project $PROJECT_ID

      # ğŸš€ Deploy App
      - name: Deploy to GKE (Kustomize)
        run: |
          sed -i "s/DOCKERHUB_USERNAME/${{ secrets.DOCKERHUB_USERNAME }}/g" k8s/base/kustomization.yaml
          kubectl apply -k k8s/base

      # ğŸ“Š Deploy Monitoring
      - name: Deploy Monitoring Stack
        run: |
          kubectl apply -k monitoring/
