name: Deploy Infra + App to GKE

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  IMAGE_NAME: hello-app
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-south1
  CLUSTER_NAME: hello-gke-cluster   # ðŸ” Replace with your actual cluster name

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ðŸ”¹ Checkout repository
      - uses: actions/checkout@v4

      # ðŸ”¹ Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ðŸ”¹ Setup gcloud CLI with GKE auth plugin
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      # ðŸ”¹ Enable GKE plugin environment variable
      - name: Enable GKE auth plugin
        run: echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      # ðŸ”¹ Check if GKE cluster exists
      - name: Check if GKE cluster exists
        id: check_cluster
        run: |
          if gcloud container clusters describe $CLUSTER_NAME \
            --region $REGION \
            --project $PROJECT_ID > /dev/null 2>&1; then
              echo "cluster_exists=true" >> $GITHUB_OUTPUT
              echo "Cluster already exists. Skipping Terraform."
          else
              echo "cluster_exists=false" >> $GITHUB_OUTPUT
              echo "Cluster does not exist. Terraform will run."
          fi

      # ðŸ”¹ Setup Terraform (only if cluster does not exist)
      - name: Setup Terraform
        if: steps.check_cluster.outputs.cluster_exists == 'false'
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        if: steps.check_cluster.outputs.cluster_exists == 'false'
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        if: steps.check_cluster.outputs.cluster_exists == 'false'
        working-directory: terraform
        run: terraform apply -auto-approve -var="project_id=${{ env.PROJECT_ID }}"

      # ðŸ”¹ Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ðŸ”¹ Build Docker image
      - name: Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest -f docker/Dockerfile .

      # ðŸ”¹ Scan Docker image with Trivy
      - name: Scan Docker Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/hello-app:latest
          format: table
          exit-code: 1
          severity: HIGH,CRITICAL

      # ðŸ”¹ Push Docker image (only if scan passes)
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest

      # ðŸ”¹ Get GKE credentials
      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials $CLUSTER_NAME \
            --region $REGION \
            --project $PROJECT_ID

      # ðŸ”¹ Deploy app using Kustomize
      - name: Deploy to GKE (Kustomize)
        run: |
          sed -i "s/DOCKERHUB_USERNAME/${{ secrets.DOCKERHUB_USERNAME }}/g" k8s/base/kustomization.yaml
          kubectl apply -k k8s/base

      # ðŸ”¹ Verify deployment rollout
      - name: Verify Deployment Rollout
        run: |
          kubectl rollout status deployment/$IMAGE_NAME

      # ðŸ”¹ Deploy monitoring stack
      - name: Deploy Monitoring Stack
        run: |
          kubectl apply -k monitoring/
